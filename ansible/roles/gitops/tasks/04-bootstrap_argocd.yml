---
- name: Ensure ArgoCD bootstrap directory exists
  file:
    path: /var/argocd/bootstrap
    state: directory

- name: Create Gitlab-Repo secret for ArgoCD
  k8s:
    state: present
    definition:
      api_version: v1
      kind: Secret
      metadata:
        name: gitlab-repo
        namespace: "{{ argocd_namespace }}"
        annotations:
          managed-by: argocd.argoproj.io
        labels:
          argocd.argoproj.io/secret-type: repository
      type: Opaque
      data: 
        password: "{{ git_repo.gitlab_password | b64encode}}"
        username: "{{ git_repo.gitlab_username | b64encode}}"
        type: "{{ git_repo.repoistory_type | b64encode}}"
        url: "{{ git_repo.gitlab_url | b64encode}}"


- name: Copy root application manifest to control plane
  template:
    src: root.yml.j2
    dest: /var/argocd/bootstrap/root.yml

- name: Deploy root application using ArgoCD
  k8s:
    namespace: "{{ argocd_namespace }}"
    state: present
    src: /var/argocd/bootstrap/root.yml
