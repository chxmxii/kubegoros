---
- block: 
    - name: Gather Certficate key
      delegate_to: "{{ kube_cluster_init_main_node_name }}"
      shell: |
        kubeadm init phase upload-certs --upload-certs
      register: kubeadm_phase_upload_certs

    - name: Set fact for certificate key
      set_fact:
        kube_cluster_certificate_key: "{{ kubeadm_phase_upload_certs.stdout_lines | select('search', '^[a-f0-9]{64}$') | list | first }}"
      delegate_facts: true
      delegate_to: "{{ item }}"
      loop: "{{ ansible_play_hosts }}"

- name: Create control plane configuration and certs diretory
  file:
    path: "{{ kubelet_config_root_dir }}/pki/etcd"
    state: directory
    owner: root
    group: root
    mode: 0640

- name: Write control plane configuration and certs
  copy: 
    dest: "{{ item.item.item }}" 
    content: "{{ item.content | b64decode }}"
    owner: root
    group: root
    mode: 0600
  loop: "{{ kube_cluster_control_plane_files.results }}"
  loop_control:
    label: "{{ item.item.item }}"

- name: Join control-plane node
  include_tasks: 04-k8s_join_node.yml

- name: Ensure .kube directory exists
  file:
    path: "{{ ansible_env.HOME }}/.kube"
    state: directory
    mode: "0755"

- name: Create Symbolic link for admin.conf
  file:
    src: "{{ kubelet_config_root_dir }}/admin.conf"
    dest: ~/.kube/config
    state: link 
    mode: '0644'